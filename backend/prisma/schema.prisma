generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ============================================
// NIVEAU 10/20 - FONCTIONNALITÉS DE BASE
// ============================================

// Énumérations
enum Role {
  READER
  AUTHOR
  ADMIN
}

enum StoryStatus {
  DRAFT
  PUBLISHED
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

// ============================================
// MODÈLES
// ============================================

model User {
  id        String   @id @default(uuid())
  pseudo    String   @unique
  email     String   @unique
  password  String // passwordHash dans le diagramme
  role      Role     @default(READER)
  status    String   @default("active") // active, banned, suspended
  isBanned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stories         Story[]
  gameSessions    GameSession[]
  ratings         Rating[]         @relation("UserRatings")
  unlockedEndings UnlockedEnding[] @relation("UserUnlockedEndings")
  authorProfile   AuthorProfile?   @relation("AuthorProfile")
  journeys        PlayerJourney[]  @relation("PlayerJourneys")
  uploadedImages  Image[]          @relation("UserImages")

  @@index([email])
  @@index([pseudo])
  @@map("users")
}

model Story {
  id          String      @id @default(uuid())
  title       String      @db.VarChar(200)
  description String      @db.Text
  theme       String?     @db.VarChar(100) // Thème de l'histoire (Fantasy, Horror, etc.)
  tags        String?     @db.Text // Stocké en JSON
  status      StoryStatus @default(DRAFT)
  isSuspended Boolean     @default(false) // Pour suspension par admin
  authorId    String
  startPageId String?     @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author          User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  pages           Page[]
  startPage       Page?            @relation("StoryStartPage", fields: [startPageId], references: [id], onDelete: SetNull)
  gameSessions    GameSession[]
  ratings         Rating[]         @relation("StoryRatings")
  unlockedEndings UnlockedEnding[] @relation("StoryUnlockedEndings")
  journeys        PlayerJourney[]  @relation("PlayerJourneys")

  @@index([authorId])
  @@index([status])
  @@map("stories")
}

model Page {
  id          String  @id @default(uuid())
  storyId     String
  title       String? @db.VarChar(200) // Titre de la page/scène
  content     String  @db.Text
  isEnd       Boolean @default(false)
  endingLabel String? @db.VarChar(100) // Label de la fin (ex: "Fin héroïque")
  order       Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  story                  Story             @relation(fields: [storyId], references: [id], onDelete: Cascade)
  choices                Choice[]          @relation("PageChoices")
  choicesTargeting       Choice[]          @relation("TargetPage")
  gameSessions           GameSession[]
  storyAsStartPage       Story?            @relation("StoryStartPage")
  unlockedEndings        UnlockedEnding[]  @relation("PageUnlockedEndings")
  interactiveZones       InteractiveZone[] @relation("PageInteractiveZones")
  interactiveZoneTargets InteractiveZone[] @relation("InteractiveZoneTarget")
  journeySteps           JourneyStep[]     @relation("JourneySteps")
  images                 Image[]           @relation("PageImages")
  diceSuccess            DiceChoice[]      @relation("DiceSuccess")
  diceFail               DiceChoice[]      @relation("DiceFail")

  @@index([storyId])
  @@index([isEnd])
  @@map("pages")
}

model Choice {
  id           String @id @default(uuid())
  pageId       String
  text         String @db.VarChar(500)
  targetPageId String
  order        Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  page           Page          @relation("PageChoices", fields: [pageId], references: [id], onDelete: Cascade)
  targetPage     Page          @relation("TargetPage", fields: [targetPageId], references: [id], onDelete: Cascade)
  diceChoice     DiceChoice?   @relation("ChoiceDice")
  journeyChoices JourneyStep[] @relation("JourneyChoices")

  @@index([pageId])
  @@index([targetPageId])
  @@map("choices")
}

model GameSession {
  id        String @id @default(uuid())
  userId    String
  storyId   String
  endPageId String

  playedAt DateTime @default(now())

  // Relations
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  story   Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  endPage Page  @relation(fields: [endPageId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([storyId])
  @@index([endPageId])
  @@map("game_sessions")
}

// ============================================
// NIVEAU 13/20 - FONCTIONNALITÉS AVANCÉES
// ============================================

model Rating {
  id      String  @id @default(uuid())
  userId  String
  storyId String
  score   Int     @db.TinyInt // 1-5
  comment String? @db.VarChar(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User  @relation("UserRatings", fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation("StoryRatings", fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@index([storyId])
  @@map("ratings")
}

model UnlockedEnding {
  id      String @id @default(uuid())
  userId  String
  storyId String
  pageId  String

  unlockedAt DateTime @default(now())

  // Relations
  user  User  @relation("UserUnlockedEndings", fields: [userId], references: [id], onDelete: Cascade)
  story Story @relation("StoryUnlockedEndings", fields: [storyId], references: [id], onDelete: Cascade)
  page  Page  @relation("PageUnlockedEndings", fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId, pageId])
  @@index([storyId])
  @@index([pageId])
  @@map("unlocked_endings")
}

// ============================================
// NIVEAU 16/20 - AUTEUR AVANCÉ
// ============================================

model AuthorProfile {
  id           String  @id @default(uuid())
  userId       String  @unique
  bio          String? @db.Text
  profileImage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation("AuthorProfile", fields: [userId], references: [id], onDelete: Cascade)

  @@map("author_profiles")
}

// ============================================
// NIVEAU 18/20 - EXPERT FEATURES
// ============================================

enum DiceType {
  D6
  D20
  D100
}

enum DiceCondition {
  EQUAL
  GREATER_EQUAL
  LESS_EQUAL
  GREATER
  LESS
}

model DiceChoice {
  id            String        @id @default(uuid())
  choiceId      String
  diceType      DiceType
  requiredValue Int
  condition     DiceCondition
  successPageId String
  failPageId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  choice      Choice     @relation("ChoiceDice", fields: [choiceId], references: [id], onDelete: Cascade)
  successPage Page       @relation("DiceSuccess", fields: [successPageId], references: [id], onDelete: Cascade)
  failPage    Page       @relation("DiceFail", fields: [failPageId], references: [id], onDelete: Cascade)
  rolls       DiceRoll[]

  @@unique([choiceId])
  @@index([choiceId])
  @@map("dice_choices")
}

model DiceRoll {
  id           String  @id @default(uuid())
  diceChoiceId String
  result       Int
  success      Boolean

  rolledAt DateTime @default(now())

  // Relations
  diceChoice DiceChoice @relation(fields: [diceChoiceId], references: [id], onDelete: Cascade)

  @@index([diceChoiceId])
  @@map("dice_rolls")
}

model InteractiveZone {
  id           String  @id @default(uuid())
  pageId       String
  shapeType    String // "rectangle", "circle", "polygon"
  coordinates  String  @db.Text // JSON array of coordinates
  targetPageId String
  tooltip      String? @db.VarChar(200)
  order        Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  page       Page @relation("PageInteractiveZones", fields: [pageId], references: [id], onDelete: Cascade)
  targetPage Page @relation("InteractiveZoneTarget", fields: [targetPageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([targetPageId])
  @@map("interactive_zones")
}

model PlayerJourney {
  id      String @id @default(uuid())
  userId  String
  storyId String
  status  String // "in_progress", "completed", "abandoned"

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  // Relations
  user  User          @relation("PlayerJourneys", fields: [userId], references: [id], onDelete: Cascade)
  story Story         @relation("PlayerJourneys", fields: [storyId], references: [id], onDelete: Cascade)
  steps JourneyStep[]

  @@index([userId])
  @@index([storyId])
  @@index([status])
  @@map("player_journeys")
}

model JourneyStep {
  id        String  @id @default(uuid())
  journeyId String
  pageId    String
  choiceId  String?
  stepOrder Int

  visitedAt DateTime @default(now())

  // Relations
  journey PlayerJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  page    Page          @relation("JourneySteps", fields: [pageId], references: [id], onDelete: Cascade)
  choice  Choice?       @relation("JourneyChoices", fields: [choiceId], references: [id], onDelete: SetNull)

  @@index([journeyId])
  @@index([pageId])
  @@map("journey_steps")
}

// ============================================
// MODÈLES ADDITIONNELS - NIVEAU 13-16
// ============================================

model Report {
  id         String       @id @default(uuid())
  storyId    String
  reporterId String
  reason     String       @db.VarChar(500)
  status     ReportStatus @default(PENDING)
  details    String?      @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Pas de relations pour éviter les références circulaires
  @@index([storyId])
  @@index([reporterId])
  @@index([status])
  @@map("reports")
}

model Statistics {
  id             String @id @default(uuid())
  storyId        String
  totalPlays     Int    @default(0)
  completedPlays Int    @default(0)
  abandonedPlays Int    @default(0)
  averageRating  Float? @default(0)
  totalRatings   Int    @default(0)

  updatedAt DateTime @updatedAt

  @@unique([storyId])
  @@map("statistics")
}

model StoryStatistics {
  id          String @id @default(uuid())
  storyId     String
  pageId      String
  viewCount   Int    @default(0)
  chosenCount Int?   @default(0) // Pour une page source de choix

  updatedAt DateTime @updatedAt

  @@unique([storyId, pageId])
  @@index([storyId])
  @@index([pageId])
  @@map("story_statistics")
}

model PreviewSession {
  id            String  @id @default(uuid())
  authorId      String
  storyId       String
  currentPageId String?

  startedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([storyId])
  @@map("preview_sessions")
}

model StoryTree {
  id      String @id @default(uuid())
  storyId String
  nodes   String @db.LongText // JSON array of nodes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storyId])
  @@index([storyId])
  @@map("story_trees")
}

model TreeNode {
  id     String @id @default(uuid())
  treeId String
  pageId String
  x      Float
  y      Float
  level  Int
  order  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([treeId])
  @@index([pageId])
  @@map("tree_nodes")
}

model TreeVisualization {
  id     String @id @default(uuid())
  treeId String
  layout String // "hierarchical", "circular", "force-directed"
  config String @db.Text // JSON config

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([treeId])
  @@map("tree_visualizations")
}

model PathAnalysis {
  id          String @id @default(uuid())
  storyId     String
  pageId      String
  percentage  Float // Pourcentage de joueurs ayant pris ce chemin
  totalVisits Int    @default(0)

  updatedAt DateTime @updatedAt

  @@unique([storyId, pageId])
  @@index([storyId])
  @@map("path_analysis")
}

model Image {
  id       String  @id @default(uuid())
  pageId   String?
  authorId String
  url      String  @db.Text
  filename String
  mimeType String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  page   Page? @relation("PageImages", fields: [pageId], references: [id], onDelete: SetNull)
  author User  @relation("UserImages", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([authorId])
  @@map("images")
}

model Notification {
  id      String  @id @default(uuid())
  userId  String
  type    String // "new_comment", "story_published", etc.
  message String  @db.Text
  read    Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model Coordinates {
  id     String @id @default(uuid())
  x      Float
  y      Float
  zoneId String

  @@index([zoneId])
  @@map("coordinates")
}
